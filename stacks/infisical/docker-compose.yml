services:
  infisical:
    image: infisical/infisical:latest
    container_name: infisical
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    # No host port: access via Caddy (infisical.home / secrets.yourdomain.com on monitor network)
    environment:
      - NODE_ENV=production
      - TZ=${TZ:-America/Denver}
      - LANG=${LANG:-en_US.UTF-8}
      - LC_ALL=${LC_ALL:-en_US.UTF-8}
      - LC_CTYPE=${LC_CTYPE:-en_US.UTF-8}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - AUTH_SECRET=${AUTH_SECRET}
      - DB_CONNECTION_URI=postgres://${POSTGRES_USER:-infisical}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-infisical}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - SITE_URL=${SITE_URL}
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-}
      - SMTP_FROM_ADDRESS=${SMTP_FROM_ADDRESS:-}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
    networks:
      - infisical
      - monitor

  redis:
    image: redis:alpine
    container_name: infisical-redis
    restart: unless-stopped
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
    networks:
      - infisical
    volumes:
      - infisical_redis_data:/data

  db:
    image: postgres:14-alpine
    container_name: infisical-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-infisical}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-infisical}
    volumes:
      - infisical_pg_data:/var/lib/postgresql/data
    networks:
      - infisical
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-infisical} -d ${POSTGRES_DB:-infisical}"]
      interval: 5s
      timeout: 10s
      retries: 10

networks:
  infisical:
    driver: bridge
  monitor:
    name: monitor
    external: true

volumes:
  infisical_pg_data:
  infisical_redis_data:
